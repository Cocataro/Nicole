<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0b0b14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OpenClaw">
<title>OpenClaw</title>
<link rel="manifest" href="/manifest.json">
<style>
:root {
  --bg:      #0b0b14;
  --card:    #12121f;
  --card2:   #181828;
  --border:  #1e1e32;
  --text:    #e2e8f0;
  --muted:   #4a5068;
  --green:   #22c55e;
  --red:     #ef4444;
  --yellow:  #f59e0b;
  --blue:    #6366f1;
  --purple:  #a855f7;
  --radius:  14px;
  --safe-t:  env(safe-area-inset-top, 0px);
  --safe-b:  env(safe-area-inset-bottom, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  min-height: 100dvh;
  padding-top: var(--safe-t);
  padding-bottom: var(--safe-b);
  overscroll-behavior: none;
}

/* ── Header ── */
.hdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px;
  background: var(--card); border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 20;
}
.hdr-logo { font-size: 19px; font-weight: 800; letter-spacing: -0.5px; }
.hdr-right { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.hdr-time  { font-size: 11px; color: var(--muted); }

/* ── Badge ── */
.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 9px; border-radius: 99px;
  font-size: 11px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.4px;
}
.badge::before { content: '●'; font-size: 7px; }
.badge.green  { background: rgba(34,197,94,.14);  color: var(--green); }
.badge.yellow { background: rgba(245,158,11,.14); color: var(--yellow); }
.badge.red    { background: rgba(239,68,68,.14);  color: var(--red); }

/* ── Progress bar ── */
.prog { height: 2px; background: var(--border); overflow: hidden; }
.prog-fill {
  height: 100%; background: var(--blue);
  transform-origin: left; animation: prog 30s linear;
}
@keyframes prog { from { transform: scaleX(1); } to { transform: scaleX(0); } }

/* ── Summary strip ── */
.strip {
  display: grid; grid-template-columns: repeat(4, 1fr);
  background: var(--border); gap: 1px;
  border-bottom: 1px solid var(--border);
}
.strip-cell { background: var(--card); padding: 11px 6px; text-align: center; }
.strip-lbl  { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; margin-bottom: 3px; }
.strip-val  { font-size: 18px; font-weight: 800; }

/* ── Content ── */
.wrap { padding: 14px 14px 40px; max-width: 560px; margin: 0 auto; }
.sec-lbl {
  font-size: 10px; font-weight: 700; color: var(--muted);
  text-transform: uppercase; letter-spacing: .7px;
  margin: 20px 0 10px;
}
.sec-lbl:first-child { margin-top: 0; }

/* ── Trader grid ── */
.traders { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.tcard {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 13px;
  transition: border-color .2s, opacity .2s;
}
.tcard.paused { opacity: .65; border-color: rgba(245,158,11,.4); }
.tcard.has-positions { border-color: rgba(99,102,241,.35); }

.tc-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
.tc-name { font-size: 15px; font-weight: 800; }
.tc-status {
  font-size: 9px; font-weight: 700; padding: 2px 7px;
  border-radius: 99px; text-transform: uppercase; letter-spacing: .3px;
}
.tc-status.active { background: rgba(34,197,94,.12);  color: var(--green); }
.tc-status.paused { background: rgba(245,158,11,.12); color: var(--yellow); }

.tc-strat { font-size: 10px; color: var(--muted); margin-bottom: 2px; }
.tc-mode {
  font-size: 9px; font-weight: 700; letter-spacing: .3px;
  text-transform: uppercase; margin-bottom: 10px;
}
.tc-mode.paper { color: var(--muted); }
.tc-mode.live  { color: var(--red); }

.tc-stats { margin-bottom: 9px; }
.tc-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
.tc-lbl  { font-size: 10px; color: var(--muted); }
.tc-val  { font-size: 13px; font-weight: 700; }

/* ── Position details inside trader card ── */
.tc-positions { margin-bottom: 9px; }
.tc-pos-lbl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 5px; }
.tc-pos-item {
  background: var(--card2); border-radius: 8px;
  padding: 8px 10px; margin-bottom: 5px; font-size: 11px;
}
.tc-pos-header { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 3px; }
.tc-pos-meta { color: var(--muted); display: flex; gap: 8px; flex-wrap: wrap; }

/* ── Unrealized / realized split ── */
.tc-pnl-split { display: flex; gap: 6px; margin-bottom: 4px; }
.pnl-chip {
  flex: 1; background: var(--card2); border-radius: 7px;
  padding: 5px 7px; text-align: center;
}
.pnl-chip-lbl { font-size: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 2px; }
.pnl-chip-val { font-size: 12px; font-weight: 700; }

.tc-btns { display: flex; gap: 6px; }
.btn {
  flex: 1; padding: 7px 2px; border-radius: 8px; border: none;
  font-size: 11px; font-weight: 700; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 3px;
  transition: opacity .15s, transform .1s; user-select: none;
}
.btn:active { opacity: .65; transform: scale(.97); }
.btn-pause  { background: rgba(245,158,11,.14); color: var(--yellow); }
.btn-resume { background: rgba(34,197,94,.14);  color: var(--green); }
.btn-close  { background: rgba(239,68,68,.12);  color: var(--red); }

/* ── Trade feed ── */
.tfeed { display: flex; flex-direction: column; gap: 8px; }
.titem {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 11px; padding: 12px 13px;
}
.ti-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.ti-coin { font-size: 14px; font-weight: 700; }
.ti-outcome {
  font-size: 10px; font-weight: 700; padding: 2px 8px;
  border-radius: 99px; text-transform: uppercase;
}
.ti-outcome.open { background: rgba(99,102,241,.14); color: #818cf8; }
.ti-outcome.won  { background: rgba(34,197,94,.14);  color: var(--green); }
.ti-outcome.lost { background: rgba(239,68,68,.14);  color: var(--red); }
.ti-meta { font-size: 11px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 6px; margin-top: 1px; }
.ti-pnl  { font-size: 13px; font-weight: 700; margin-top: 4px; }

/* ── Cron grid ── */
.crons { display: flex; flex-direction: column; gap: 8px; }
.cron-item {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 11px; padding: 11px 13px;
  display: flex; flex-direction: column; gap: 4px;
}
.cron-item.disabled { opacity: .5; }
.cron-item.error { border-color: rgba(239,68,68,.35); }
.cron-head { display: flex; justify-content: space-between; align-items: center; }
.cron-name { font-size: 13px; font-weight: 700; }
.cron-chip {
  font-size: 9px; font-weight: 700; padding: 2px 7px;
  border-radius: 99px; text-transform: uppercase;
}
.cron-chip.enabled  { background: rgba(34,197,94,.12);  color: var(--green); }
.cron-chip.disabled { background: rgba(74,80,104,.12);  color: var(--muted); }
.cron-chip.error    { background: rgba(239,68,68,.12);  color: var(--red); }
.cron-desc { font-size: 10px; color: var(--muted); }
.cron-meta { display: flex; gap: 10px; flex-wrap: wrap; font-size: 10px; color: var(--muted); }
.cron-meta span { display: flex; align-items: center; gap: 3px; }
.cron-error { font-size: 10px; color: var(--red); margin-top: 2px; }
.cron-model { font-size: 9px; color: var(--muted); opacity: .7; }

/* ── Sparkline ── */
.tc-sparkline { margin-bottom: 9px; }
.tc-spark-lbl { font-size: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 3px; }
.spark-svg { width: 100%; height: 28px; display: block; }
.spark-area { fill: rgba(99,102,241,.10); }
.spark-line { fill: none; stroke: var(--blue); stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
.spark-line.pos { stroke: var(--green); }
.spark-line.neg { stroke: var(--red); }
.spark-area.pos { fill: rgba(34,197,94,.10); }
.spark-area.neg { fill: rgba(239,68,68,.10); }

/* ── Risk panel ── */
.risk-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.risk-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 11px 13px;
  display: flex; align-items: center; justify-content: space-between;
}
.risk-card.green  { border-color: rgba(34,197,94,.2); }
.risk-card.yellow { border-color: rgba(245,158,11,.4); }
.risk-card.red    { border-color: rgba(239,68,68,.5); }
.risk-name { font-size: 13px; font-weight: 700; }
.risk-strat { font-size: 9px; color: var(--muted); margin-top: 1px; }

/* ── Colors ── */
.pos { color: var(--green); }
.neg { color: var(--red); }
.dim { color: var(--muted); }

/* ── Empty / loading ── */
.empty { text-align: center; padding: 28px 16px; color: var(--muted); font-size: 13px; }
.spinner {
  display: inline-block; width: 20px; height: 20px;
  border: 2px solid var(--border); border-top-color: var(--blue);
  border-radius: 50%; animation: spin .7s linear infinite; margin-bottom: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Toast ── */
.toast {
  position: fixed; bottom: calc(24px + var(--safe-b)); left: 50%;
  transform: translateX(-50%);
  background: var(--card2); border: 1px solid var(--border);
  color: var(--text); padding: 9px 18px; border-radius: 99px;
  font-size: 13px; font-weight: 500; z-index: 99;
  opacity: 0; transition: opacity .25s; white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; }

/* ── Confirm dialog ── */
.overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
  z-index: 50; align-items: flex-end; justify-content: center;
  padding: 0 12px calc(20px + var(--safe-b));
}
.overlay.show { display: flex; }
.dialog {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 18px; padding: 20px 18px; width: 100%; max-width: 400px;
}
.dlg-title { font-size: 16px; font-weight: 800; margin-bottom: 6px; }
.dlg-body  { font-size: 13px; color: var(--muted); margin-bottom: 20px; line-height: 1.5; }
.dlg-btns  { display: flex; gap: 10px; }
.btn-cancel      { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-confirm-red { flex: 1; padding: 12px; border-radius: 10px; border: none; background: var(--red); color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; }
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-logo">⚡ OpenClaw</div>
  <div class="hdr-right">
    <span class="badge green" id="dylon-badge">Green</span>
    <span class="hdr-time" id="last-updated">—</span>
  </div>
</div>

<div class="prog"><div class="prog-fill" id="prog-fill"></div></div>

<div class="strip">
  <div class="strip-cell">
    <div class="strip-lbl">Bankroll</div>
    <div class="strip-val" id="s-bankroll">—</div>
  </div>
  <div class="strip-cell">
    <div class="strip-lbl">P&amp;L</div>
    <div class="strip-val" id="s-pnl">—</div>
  </div>
  <div class="strip-cell">
    <div class="strip-lbl">Positions</div>
    <div class="strip-val" id="s-pos">—</div>
  </div>
  <div class="strip-cell">
    <div class="strip-lbl">Win Rate</div>
    <div class="strip-val" id="s-wr">—</div>
  </div>
</div>

<div class="wrap">

  <div class="sec-lbl">Traders</div>
  <div class="traders" id="traders">
    <div class="empty" style="grid-column:1/-1"><div class="spinner"></div><br>Loading…</div>
  </div>

  <div class="sec-lbl">Risk — Dylon</div>
  <div class="risk-grid" id="risk-grid">
    <div class="empty" style="grid-column:1/-1"><div class="spinner"></div><br>Loading…</div>
  </div>

  <div class="sec-lbl">Schedule</div>
  <div class="crons" id="crons">
    <div class="empty"><div class="spinner"></div><br>Loading…</div>
  </div>

  <div class="sec-lbl">Recent Trades</div>
  <div class="tfeed" id="trades">
    <div class="empty"><div class="spinner"></div><br>Loading…</div>
  </div>

</div>

<!-- Confirm dialog -->
<div class="overlay" id="overlay">
  <div class="dialog">
    <div class="dlg-title" id="dlg-title">Close all positions?</div>
    <div class="dlg-body"  id="dlg-body">This will flag all open positions to close and pause trading.</div>
    <div class="dlg-btns">
      <button class="btn-cancel" onclick="closeDialog()">Cancel</button>
      <button class="btn-confirm-red" id="dlg-confirm">Close All</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// ── Formatters ────────────────────────────────────────────────
const fmt$ = v => {
  const n = parseFloat(v);
  return isNaN(n) ? '—' : '$' + Math.abs(n).toFixed(2);
};
const fmtPnl = v => {
  const n = parseFloat(v);
  if (isNaN(n) || n === 0) return { text: '$0.00', cls: 'dim' };
  return { text: (n > 0 ? '+' : '-') + '$' + Math.abs(n).toFixed(2), cls: n > 0 ? 'pos' : 'neg' };
};
const fmtAgo = ms => {
  if (!ms) return '—';
  const s = Math.floor((Date.now() - ms) / 1000);
  if (s < 60)   return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s / 60)}m ago`;
  if (s < 86400)return `${Math.floor(s / 3600)}h ago`;
  return `${Math.floor(s / 86400)}d ago`;
};
const fmtIn = ms => {
  if (!ms || ms <= 0) return 'now';
  if (ms < 60000)   return `${Math.floor(ms / 1000)}s`;
  if (ms < 3600000) return `${Math.floor(ms / 60000)}m`;
  if (ms < 86400000)return `${Math.floor(ms / 3600000)}h`;
  return `${Math.floor(ms / 86400000)}d`;
};
const shortModel = m => {
  if (!m) return '';
  if (m.includes('gemini'))   return 'Gemini';
  if (m.includes('haiku'))    return 'Haiku';
  if (m.includes('sonnet'))   return 'Sonnet';
  if (m.includes('opus'))     return 'Opus';
  if (m.includes('qwen'))     return 'Qwen (local)';
  return m.split('/').pop();
};

// ── Toast ─────────────────────────────────────────────────────
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

// ── Dialog ────────────────────────────────────────────────────
let dialogResolve;
function showDialog(title, body, confirmLabel = 'Confirm') {
  return new Promise(resolve => {
    dialogResolve = resolve;
    document.getElementById('dlg-title').textContent = title;
    document.getElementById('dlg-body').textContent  = body;
    document.getElementById('dlg-confirm').textContent = confirmLabel;
    document.getElementById('overlay').classList.add('show');
  });
}
function closeDialog(result = false) {
  document.getElementById('overlay').classList.remove('show');
  if (dialogResolve) { dialogResolve(result); dialogResolve = null; }
}
document.getElementById('dlg-confirm').onclick = () => closeDialog(true);
document.getElementById('overlay').onclick = e => { if (e.target === e.currentTarget) closeDialog(); };

// ── API ───────────────────────────────────────────────────────
async function api(url, method = 'GET') {
  const r = await fetch(url, { method });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ── Actions ───────────────────────────────────────────────────
async function togglePause(id, currentlyPaused) {
  const ep = currentlyPaused ? `/api/trader/${id}/resume` : `/api/trader/${id}/pause`;
  try {
    await api(ep, 'POST');
    toast(currentlyPaused ? `${id} resumed ▶` : `${id} paused ⏸`);
    loadAll();
  } catch { toast('Request failed'); }
}

async function closeAll(id) {
  const ok = await showDialog(
    `Close all of ${id}'s positions?`,
    'This will set the close-all flag and pause trading. Positions will be closed on the next agent cycle.',
    'Close All'
  );
  if (!ok) return;
  try {
    await api(`/api/trader/${id}/close-all`, 'POST');
    toast(`Close-all flagged for ${id} ✕`);
    loadAll();
  } catch { toast('Request failed'); }
}

// ── Sparkline ─────────────────────────────────────────────────
function buildSparkline(points, startBalance) {
  // points: array of {day, avg_balance} sorted ascending
  if (!points || points.length < 2) return '';
  const vals = points.map(p => parseFloat(p.avg_balance));
  const min  = Math.min(...vals);
  const max  = Math.max(...vals);
  const range = max - min || 1;
  const W = 100, H = 28, pad = 2;

  const xs = points.map((_, i) => pad + (i / (points.length - 1)) * (W - 2 * pad));
  const ys = vals.map(v => pad + (1 - (v - min) / range) * (H - 2 * pad));

  const last = vals[vals.length - 1];
  const trend = last >= (startBalance || vals[0]) ? 'pos' : 'neg';

  const pts  = xs.map((x, i) => `${x.toFixed(1)},${ys[i].toFixed(1)}`).join(' ');
  const poly = pts + ` ${xs[xs.length-1].toFixed(1)},${H} ${xs[0].toFixed(1)},${H}`;

  return `<svg class="spark-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
    <polygon class="spark-area ${trend}" points="${poly}"/>
    <polyline class="spark-line ${trend}" points="${pts}"/>
  </svg>`;
}

// ── Render: Risk Panel ────────────────────────────────────────
function renderRisk(riskData) {
  const el = document.getElementById('risk-grid');
  const traderInfo = { max: 'The Sniper', leo: 'EMA Crossover', zara: 'RSI Reversal', kai: 'VWAP Reversion' };
  const traders = ['max', 'leo', 'zara', 'kai'];

  el.innerHTML = traders.map(id => {
    const light = (riskData?.[id] || 'Green').toLowerCase();
    const label = light.charAt(0).toUpperCase() + light.slice(1);
    return `<div class="risk-card ${light}">
  <div>
    <div class="risk-name">${id.charAt(0).toUpperCase() + id.slice(1)}</div>
    <div class="risk-strat">${traderInfo[id]}</div>
  </div>
  <div class="badge ${light}">${label}</div>
</div>`;
  }).join('');
}

// ── Render: Traders ───────────────────────────────────────────
function renderTraders(traders, history) {
  const el = document.getElementById('traders');
  if (!traders.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1">No data</div>'; return; }

  el.innerHTML = traders.map(t => {
    const totalPnl  = fmtPnl(t.total_pnl);
    const unrPnl    = fmtPnl(t.unrealized_pnl);
    const realPnl   = fmtPnl(t.realized_pnl);
    const paused    = t.paused;
    const hasPos    = t.position_count > 0;
    // prefer DB win rate / trade count if available
    const wr        = (t.db_win_rate !== undefined ? t.db_win_rate : t.win_rate) !== null
                        ? (t.db_win_rate ?? t.win_rate) + '%' : '—';
    const trades    = t.db_total_trades ?? t.total_trades;
    const modeCls   = t.mode?.toLowerCase() === 'live' ? 'live' : 'paper';
    const modeLabel = t.mode?.toUpperCase() || 'PAPER';
    const cardCls   = ['tcard', paused ? 'paused' : '', hasPos ? 'has-positions' : ''].filter(Boolean).join(' ');

    // Sparkline for this trader
    const sparkPoints = (history || []).filter(h => h.trader === t.id);
    const sparkHtml   = sparkPoints.length >= 2
      ? `<div class="tc-sparkline">
          <div class="tc-spark-lbl">7d Bankroll</div>
          ${buildSparkline(sparkPoints, 50)}
        </div>`
      : '';

    // Build positions HTML
    let posHtml = '';
    if (hasPos && t.positions.length) {
      const items = t.positions.map(p => {
        const lbl    = p.label || 'Position';
        const entry  = p['Entry'] || p['Entry Price'] || '';
        const target = p['Target'] || p['Target Price'] || '';
        const stop   = p['Stop'] || p['Stop Loss'] || '';
        const opened = p['Opened'] || p['Date Opened'] || '';
        return `<div class="tc-pos-item">
          <div class="tc-pos-header"><span>${lbl}</span></div>
          <div class="tc-pos-meta">
            ${entry  ? `<span>Entry ${entry}</span>`  : ''}
            ${target ? `<span>→ ${target}</span>` : ''}
            ${stop   ? `<span>Stop ${stop}</span>` : ''}
            ${opened ? `<span>${opened}</span>` : ''}
          </div>
        </div>`;
      }).join('');
      posHtml = `<div class="tc-positions">
        <div class="tc-pos-lbl">${t.position_count} Open Position${t.position_count > 1 ? 's' : ''}</div>
        ${items}
      </div>`;
    }

    return `<div class="${cardCls}">
  <div class="tc-head">
    <div class="tc-name">${t.emoji} ${t.name}</div>
    <div class="tc-status ${paused ? 'paused' : 'active'}">${paused ? 'Paused' : 'Active'}</div>
  </div>
  <div class="tc-strat">${t.strategy}</div>
  <div class="tc-mode ${modeCls}">${modeLabel}</div>
  <div class="tc-stats">
    <div class="tc-row">
      <span class="tc-lbl">Bankroll</span>
      <span class="tc-val">${fmt$(t.bankroll)}</span>
    </div>
    <div class="tc-row">
      <span class="tc-lbl">Total P&amp;L</span>
      <span class="tc-val ${totalPnl.cls}">${totalPnl.text}</span>
    </div>
    <div class="tc-pnl-split">
      <div class="pnl-chip">
        <div class="pnl-chip-lbl">Unrealized</div>
        <div class="pnl-chip-val ${unrPnl.cls}">${unrPnl.text}</div>
      </div>
      <div class="pnl-chip">
        <div class="pnl-chip-lbl">Realized</div>
        <div class="pnl-chip-val ${realPnl.cls}">${realPnl.text}</div>
      </div>
    </div>
    <div class="tc-row">
      <span class="tc-lbl">Win rate</span>
      <span class="tc-val">${wr}</span>
    </div>
    <div class="tc-row">
      <span class="tc-lbl">Trades</span>
      <span class="tc-val">${trades || '—'}</span>
    </div>
  </div>
  ${sparkHtml}
  ${posHtml}
  <div class="tc-btns">
    <button class="btn ${paused ? 'btn-resume' : 'btn-pause'}" onclick="togglePause('${t.id}', ${paused})">
      ${paused ? '▶ Resume' : '⏸ Pause'}
    </button>
    ${hasPos ? `<button class="btn btn-close" onclick="closeAll('${t.id}')">✕ Close</button>` : ''}
  </div>
</div>`;
  }).join('');
}

// ── Render: Crons ─────────────────────────────────────────────
function renderCrons(jobs) {
  const el = document.getElementById('crons');
  if (!jobs.length) { el.innerHTML = '<div class="empty">No cron data</div>'; return; }

  // Sort: enabled first, then by name
  const sorted = [...jobs].sort((a, b) => {
    if (a.enabled !== b.enabled) return b.enabled ? 1 : -1;
    return a.name.localeCompare(b.name);
  });

  el.innerHTML = sorted.map(j => {
    const hasError   = j.consecutiveErrors > 0 || j.lastStatus === 'error';
    const chipLabel  = !j.enabled ? 'Off' : hasError ? 'Error' : 'On';
    const chipCls    = !j.enabled ? 'disabled' : hasError ? 'error' : 'enabled';
    const cardCls    = ['cron-item', !j.enabled ? 'disabled' : '', hasError ? 'error' : ''].filter(Boolean).join(' ');

    const schedLabel = j.scheduleKind === 'every'
      ? `Every ${fmtIn(j.everyMs)}`
      : j.cronExpr
        ? `Cron: ${j.cronExpr}${j.tz ? ' ' + j.tz.replace('America/', '') : ''}`
        : '';

    return `<div class="${cardCls}">
  <div class="cron-head">
    <div class="cron-name">${j.name}</div>
    <div class="cron-chip ${chipCls}">${chipLabel}</div>
  </div>
  <div class="cron-meta">
    ${j.lastRunAtMs ? `<span>Last: ${fmtAgo(j.lastRunAtMs)}${j.lastDurationMs ? ` (${(j.lastDurationMs/1000).toFixed(0)}s)` : ''}</span>` : '<span>Never run</span>'}
    ${j.enabled && j.msUntilNext !== null ? `<span>Next: ${fmtIn(j.msUntilNext)}</span>` : ''}
    ${schedLabel ? `<span>${schedLabel}</span>` : ''}
    ${j.model ? `<span>${shortModel(j.model)}</span>` : ''}
  </div>
  ${hasError && j.lastError ? `<div class="cron-error">⚠ ${j.lastError}</div>` : ''}
</div>`;
  }).join('');
}

// ── Render: Trades ────────────────────────────────────────────
function renderTrades(trades) {
  const el = document.getElementById('trades');
  if (!trades.length) { el.innerHTML = '<div class="empty">No trades yet</div>'; return; }

  el.innerHTML = trades.slice(0, 30).map(t => {
    // Support both SQLite format and legacy TRADE_LOG.md format
    const isSqlite = t.pair !== undefined;

    const coin   = isSqlite ? t.pair : (t['Coin'] || t['Market'] || 'Unknown');
    const rawSt  = isSqlite ? t.status : (t['Status'] || (t._hasExit ? 'Closed' : 'Open'));
    const status = (rawSt || 'open').toUpperCase();
    const pnl    = isSqlite ? t.pnl : t['P&L'];
    const pnlPct = isSqlite ? t.pnl_pct : null;
    const ts     = isSqlite ? (t.opened_at || '') : (t['Timestamp (UTC)'] || t['Date Opened'] || '');
    const dir    = isSqlite ? t.side : (t['Direction'] || t['Position'] || '');
    const trader = isSqlite ? t.trader : (t.trader || '');
    const entry  = isSqlite ? t.entry_price : t['Entry Price'];
    const strat  = isSqlite ? t.strategy : null;

    const sc     = status === 'WON' ? 'won' : status === 'LOST' ? 'lost' : 'open';
    const pnlFmt = pnl !== null && pnl !== undefined ? fmtPnl(pnl) : null;
    const pctStr = pnlPct !== null && pnlPct !== undefined
      ? ` (${pnlPct >= 0 ? '+' : ''}${parseFloat(pnlPct).toFixed(1)}%)` : '';

    return `<div class="titem">
  <div class="ti-head">
    <div class="ti-coin">${coin}</div>
    <div class="ti-outcome ${sc}">${status}</div>
  </div>
  <div class="ti-meta">
    ${trader ? `<span>${trader.charAt(0).toUpperCase()+trader.slice(1)}</span>` : ''}
    ${dir    ? `<span>${dir.toUpperCase()}</span>` : ''}
    ${entry  ? `<span>@ ${typeof entry === 'number' ? entry.toLocaleString() : entry}</span>` : ''}
    ${strat  ? `<span>${strat}</span>` : ''}
    ${ts     ? `<span>${ts.slice(0, 10)}</span>` : ''}
  </div>
  ${pnlFmt ? `<div class="ti-pnl ${pnlFmt.cls}">${pnlFmt.text}${pctStr}</div>` : ''}
</div>`;
  }).join('');
}

// ── Refresh ───────────────────────────────────────────────────
async function loadAll() {
  try {
    const [status, trades, crons, history, risk] = await Promise.all([
      api('/api/status'),
      api('/api/trades'),
      api('/api/crons'),
      api('/api/history?days=7').catch(() => []),
      api('/api/risk').catch(() => null),
    ]);

    // Summary strip
    const s = status.summary;
    document.getElementById('s-bankroll').textContent = fmt$(s.total_bankroll);

    const pnlEl = document.getElementById('s-pnl');
    const pnl = fmtPnl(s.total_pnl);
    pnlEl.textContent = pnl.text;
    pnlEl.className = 'strip-val ' + pnl.cls;

    document.getElementById('s-pos').textContent = s.total_positions;

    // Win rate: prefer DB data, fall back to TRADE_STATE.md
    const wrs = status.traders
      .map(t => t.db_win_rate ?? t.win_rate)
      .filter(v => v !== null && v !== undefined);
    document.getElementById('s-wr').textContent =
      wrs.length ? (wrs.reduce((a,b) => a+b, 0) / wrs.length).toFixed(0) + '%' : '—';

    // Dylon badge
    const badge = document.getElementById('dylon-badge');
    const dyLight = s.dylon_status || 'Green';
    badge.className = `badge ${dyLight.toLowerCase()}`;
    badge.textContent = dyLight;

    // Timestamp
    document.getElementById('last-updated').textContent =
      new Date(status.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    renderTraders(status.traders, history);
    renderRisk(risk?.traders || s.dylon_details || {});
    renderCrons(Array.isArray(crons) ? crons : []);
    renderTrades(Array.isArray(trades) ? trades : []);

    // Reset progress bar
    const bar = document.getElementById('prog-fill');
    bar.style.animation = 'none';
    void bar.offsetWidth;
    bar.style.animation = '';
  } catch (e) {
    console.error('Refresh error:', e);
    toast('Connection error — retrying…');
  }
}

loadAll();
setInterval(loadAll, 30000);
</script>
</body>
</html>
