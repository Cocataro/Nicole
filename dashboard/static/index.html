<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0b0b14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OpenClaw">
<title>OpenClaw</title>
<link rel="manifest" href="/manifest.json">
<style>
:root {
  --bg:      #0b0b14;
  --card:    #12121f;
  --card2:   #181828;
  --border:  #1e1e32;
  --text:    #e2e8f0;
  --muted:   #4a5068;
  --green:   #22c55e;
  --red:     #ef4444;
  --yellow:  #f59e0b;
  --blue:    #6366f1;
  --radius:  14px;
  --safe-t:  env(safe-area-inset-top, 0px);
  --safe-b:  env(safe-area-inset-bottom, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  min-height: 100dvh;
  padding-top: var(--safe-t);
  padding-bottom: var(--safe-b);
  overscroll-behavior: none;
}

/* ── Header ── */
.hdr {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 20;
}
.hdr-logo { font-size: 19px; font-weight: 800; letter-spacing: -0.5px; }
.hdr-right { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.hdr-time { font-size: 11px; color: var(--muted); }

/* ── Dylon badge ── */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 9px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}
.badge::before { content: '●'; font-size: 7px; }
.badge.green  { background: rgba(34,197,94,.14);  color: var(--green); }
.badge.yellow { background: rgba(245,158,11,.14); color: var(--yellow); }
.badge.red    { background: rgba(239,68,68,.14);  color: var(--red); }

/* ── Progress bar ── */
.prog { height: 2px; background: var(--border); overflow: hidden; }
.prog-fill {
  height: 100%;
  background: var(--blue);
  transform-origin: left;
  animation: prog 30s linear;
}
@keyframes prog { from { transform: scaleX(1); } to { transform: scaleX(0); } }

/* ── Summary strip ── */
.strip {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  background: var(--border);
  gap: 1px;
  border-bottom: 1px solid var(--border);
}
.strip-cell {
  background: var(--card);
  padding: 12px 8px;
  text-align: center;
}
.strip-lbl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; margin-bottom: 4px; }
.strip-val { font-size: 20px; font-weight: 800; }

/* ── Content ── */
.wrap { padding: 14px 14px 32px; max-width: 540px; margin: 0 auto; }
.sec-lbl {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .7px;
  margin: 20px 0 10px;
}
.sec-lbl:first-child { margin-top: 0; }

/* ── Trader grid ── */
.traders { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.tcard {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 13px;
  transition: border-color .2s, opacity .2s;
}
.tcard.paused { opacity: .65; border-color: rgba(245,158,11,.4); }

.tc-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.tc-name { font-size: 15px; font-weight: 800; }
.tc-status {
  font-size: 9px; font-weight: 700; padding: 2px 7px;
  border-radius: 99px; text-transform: uppercase; letter-spacing: .3px;
}
.tc-status.active  { background: rgba(34,197,94,.12);  color: var(--green); }
.tc-status.paused  { background: rgba(245,158,11,.12); color: var(--yellow); }

.tc-strat { font-size: 10px; color: var(--muted); margin-bottom: 10px; }

.tc-stats { margin-bottom: 11px; }
.tc-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
.tc-lbl  { font-size: 10px; color: var(--muted); }
.tc-val  { font-size: 13px; font-weight: 700; }

.tc-btns { display: flex; gap: 6px; }
.btn {
  flex: 1; padding: 7px 2px;
  border-radius: 8px; border: none;
  font-size: 11px; font-weight: 700;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 3px;
  transition: opacity .15s, transform .1s;
  user-select: none;
}
.btn:active { opacity: .65; transform: scale(.97); }
.btn-pause  { background: rgba(245,158,11,.14); color: var(--yellow); }
.btn-resume { background: rgba(34,197,94,.14);  color: var(--green); }
.btn-close  { background: rgba(239,68,68,.12);  color: var(--red); }

/* ── Trade feed ── */
.tfeed { display: flex; flex-direction: column; gap: 8px; }
.titem {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 11px;
  padding: 12px 13px;
}
.ti-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.ti-coin { font-size: 14px; font-weight: 700; }
.ti-outcome {
  font-size: 10px; font-weight: 700; padding: 2px 8px;
  border-radius: 99px; text-transform: uppercase;
}
.ti-outcome.open { background: rgba(99,102,241,.14); color: #818cf8; }
.ti-outcome.won  { background: rgba(34,197,94,.14);  color: var(--green); }
.ti-outcome.lost { background: rgba(239,68,68,.14);  color: var(--red); }

.ti-meta { font-size: 11px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 6px; margin-top: 1px; }
.ti-pnl  { font-size: 13px; font-weight: 700; margin-top: 4px; }

/* ── Colors ── */
.pos  { color: var(--green); }
.neg  { color: var(--red); }
.dim  { color: var(--muted); }

/* ── Empty / loading ── */
.empty { text-align: center; padding: 28px 16px; color: var(--muted); font-size: 13px; }
.spinner {
  display: inline-block; width: 20px; height: 20px;
  border: 2px solid var(--border); border-top-color: var(--blue);
  border-radius: 50%; animation: spin .7s linear infinite; margin-bottom: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Toast ── */
.toast {
  position: fixed; bottom: calc(24px + var(--safe-b)); left: 50%;
  transform: translateX(-50%);
  background: var(--card2); border: 1px solid var(--border);
  color: var(--text); padding: 9px 18px; border-radius: 99px;
  font-size: 13px; font-weight: 500; z-index: 99;
  opacity: 0; transition: opacity .25s; white-space: nowrap;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* ── Confirm dialog ── */
.overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
  z-index: 50; align-items: flex-end; justify-content: center;
  padding: 0 12px calc(20px + var(--safe-b));
}
.overlay.show { display: flex; }
.dialog {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 18px; padding: 20px 18px; width: 100%; max-width: 400px;
}
.dlg-title  { font-size: 16px; font-weight: 800; margin-bottom: 6px; }
.dlg-body   { font-size: 13px; color: var(--muted); margin-bottom: 20px; line-height: 1.5; }
.dlg-btns   { display: flex; gap: 10px; }
.btn-cancel { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-confirm-red { flex: 1; padding: 12px; border-radius: 10px; border: none; background: var(--red); color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; }
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-logo">⚡ OpenClaw</div>
  <div class="hdr-right">
    <span class="badge green" id="dylon-badge">Green</span>
    <span class="hdr-time" id="last-updated">—</span>
  </div>
</div>

<div class="prog"><div class="prog-fill" id="prog-fill"></div></div>

<div class="strip">
  <div class="strip-cell">
    <div class="strip-lbl">Bankroll</div>
    <div class="strip-val" id="s-bankroll">—</div>
  </div>
  <div class="strip-cell">
    <div class="strip-lbl">P&amp;L</div>
    <div class="strip-val" id="s-pnl">—</div>
  </div>
  <div class="strip-cell">
    <div class="strip-lbl">Positions</div>
    <div class="strip-val" id="s-pos">—</div>
  </div>
</div>

<div class="wrap">
  <div class="sec-lbl">Traders</div>
  <div class="traders" id="traders">
    <div class="empty" style="grid-column:1/-1"><div class="spinner"></div><br>Loading…</div>
  </div>

  <div class="sec-lbl" style="margin-top:24px;">Recent Trades</div>
  <div class="tfeed" id="trades">
    <div class="empty"><div class="spinner"></div><br>Loading…</div>
  </div>
</div>

<!-- Confirm dialog -->
<div class="overlay" id="overlay">
  <div class="dialog">
    <div class="dlg-title" id="dlg-title">Close all positions?</div>
    <div class="dlg-body" id="dlg-body">This will flag all open positions to close and pause trading.</div>
    <div class="dlg-btns">
      <button class="btn-cancel" onclick="closeDialog()">Cancel</button>
      <button class="btn-confirm-red" id="dlg-confirm">Close All</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// ── Formatters ──────────────────────────────────────────────
const fmt$ = v => {
  const n = parseFloat(v);
  if (isNaN(n)) return '—';
  return '$' + Math.abs(n).toFixed(2);
};
const fmtPnl = v => {
  const n = parseFloat(v);
  if (isNaN(n) || n === 0) return { text: '$0.00', cls: 'dim' };
  return { text: (n > 0 ? '+' : '-') + '$' + Math.abs(n).toFixed(2), cls: n > 0 ? 'pos' : 'neg' };
};

// ── Toast ───────────────────────────────────────────────────
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

// ── Dialog ──────────────────────────────────────────────────
let dialogResolve;
function showDialog(title, body, confirmLabel = 'Confirm') {
  return new Promise(resolve => {
    dialogResolve = resolve;
    document.getElementById('dlg-title').textContent = title;
    document.getElementById('dlg-body').textContent = body;
    document.getElementById('dlg-confirm').textContent = confirmLabel;
    document.getElementById('overlay').classList.add('show');
  });
}
function closeDialog(result = false) {
  document.getElementById('overlay').classList.remove('show');
  if (dialogResolve) { dialogResolve(result); dialogResolve = null; }
}
document.getElementById('dlg-confirm').onclick = () => closeDialog(true);
document.getElementById('overlay').onclick = e => { if (e.target === e.currentTarget) closeDialog(); };

// ── API calls ────────────────────────────────────────────────
async function api(url, method = 'GET') {
  const r = await fetch(url, { method });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ── Actions ──────────────────────────────────────────────────
async function togglePause(id, currentlyPaused) {
  const endpoint = currentlyPaused ? `/api/trader/${id}/resume` : `/api/trader/${id}/pause`;
  try {
    await api(endpoint, 'POST');
    toast(currentlyPaused ? `${id} resumed ▶` : `${id} paused ⏸`);
    refresh();
  } catch { toast('Request failed'); }
}

async function closeAll(id) {
  const ok = await showDialog(
    `Close all of ${id}'s positions?`,
    'This will set the close-all flag and pause trading. Positions will be closed on the next agent cycle.',
    'Close All'
  );
  if (!ok) return;
  try {
    await api(`/api/trader/${id}/close-all`, 'POST');
    toast(`Close-all flagged for ${id} ✕`);
    refresh();
  } catch { toast('Request failed'); }
}

// ── Render ────────────────────────────────────────────────────
function renderTraders(traders) {
  const el = document.getElementById('traders');
  if (!traders.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1">No data</div>'; return; }

  el.innerHTML = traders.map(t => {
    const pnl = fmtPnl(t.total_pnl);
    const paused = t.paused;
    const hasPos = t.position_count > 0;
    const wr = t.win_rate !== null ? t.win_rate + '%' : '—';

    return `<div class="tcard ${paused ? 'paused' : ''}">
  <div class="tc-head">
    <div class="tc-name">${t.emoji} ${t.name}</div>
    <div class="tc-status ${paused ? 'paused' : 'active'}">${paused ? 'Paused' : 'Active'}</div>
  </div>
  <div class="tc-strat">${t.strategy}</div>
  <div class="tc-stats">
    <div class="tc-row">
      <span class="tc-lbl">Bankroll</span>
      <span class="tc-val">${fmt$(t.bankroll)}</span>
    </div>
    <div class="tc-row">
      <span class="tc-lbl">P&amp;L</span>
      <span class="tc-val ${pnl.cls}">${pnl.text}</span>
    </div>
    <div class="tc-row">
      <span class="tc-lbl">Open</span>
      <span class="tc-val">${hasPos ? t.position_count : '—'}</span>
    </div>
    <div class="tc-row">
      <span class="tc-lbl">Win rate</span>
      <span class="tc-val">${wr}</span>
    </div>
  </div>
  <div class="tc-btns">
    <button class="btn ${paused ? 'btn-resume' : 'btn-pause'}" onclick="togglePause('${t.id}', ${paused})">
      ${paused ? '▶ Resume' : '⏸ Pause'}
    </button>
    ${hasPos ? `<button class="btn btn-close" onclick="closeAll('${t.id}')">✕ Close</button>` : ''}
  </div>
</div>`;
  }).join('');
}

function renderTrades(trades) {
  const el = document.getElementById('trades');
  const real = trades.filter(t => t['Timestamp (UTC)'] || t['Date Opened']);
  if (!real.length) { el.innerHTML = '<div class="empty">No trades yet</div>'; return; }

  el.innerHTML = real.slice(0, 30).map(t => {
    const coin   = t['Coin'] || t['Market'] || 'Unknown';
    const status = (t['Status'] || t['Outcome'] || 'OPEN').toUpperCase();
    const pnl    = t['Realized P&L ($)'] || t['P&L'];
    const ts     = t['Timestamp (UTC)'] || t['Date Opened'] || '';
    const dir    = t['Direction'] || t['Position'] || '';
    const trader = t.trader || '';

    const sc = status === 'WON' ? 'won' : status === 'LOST' ? 'lost' : 'open';
    const pnlFmt = pnl ? fmtPnl(pnl) : null;

    return `<div class="titem">
  <div class="ti-head">
    <div class="ti-coin">${coin}</div>
    <div class="ti-outcome ${sc}">${status}</div>
  </div>
  <div class="ti-meta">
    ${trader ? `<span>${trader}</span>` : ''}
    ${dir ? `<span>${dir}</span>` : ''}
    ${ts ? `<span>${ts.slice(0, 10)}</span>` : ''}
  </div>
  ${pnlFmt ? `<div class="ti-pnl ${pnlFmt.cls}">${pnlFmt.text}</div>` : ''}
</div>`;
  }).join('');
}

// ── Refresh ───────────────────────────────────────────────────
async function loadAll() {
  try {
    const [status, trades] = await Promise.all([api('/api/status'), api('/api/trades')]);

    // Summary
    const s = status.summary;
    document.getElementById('s-bankroll').textContent = fmt$(s.total_bankroll);
    const pnl = fmtPnl(s.total_pnl);
    const pnlEl = document.getElementById('s-pnl');
    pnlEl.textContent = pnl.text;
    pnlEl.className = 'strip-val ' + pnl.cls;
    document.getElementById('s-pos').textContent = s.total_positions;

    // Dylon
    const badge = document.getElementById('dylon-badge');
    badge.className = `badge ${s.dylon_status.toLowerCase()}`;
    badge.textContent = s.dylon_status;

    // Time
    document.getElementById('last-updated').textContent =
      new Date(status.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    renderTraders(status.traders);
    renderTrades(trades);

    // Reset progress bar
    const bar = document.getElementById('prog-fill');
    bar.style.animation = 'none';
    void bar.offsetWidth;
    bar.style.animation = '';
  } catch (e) {
    console.error('Refresh error:', e);
    toast('Connection error — retrying…');
  }
}

function refresh() { loadAll(); }

loadAll();
setInterval(loadAll, 30000);
</script>
</body>
</html>
